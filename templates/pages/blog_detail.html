{% extends 'base.html' %}
{% load static mathfilters %}

{% block title %}{{ post.title }} - {{ site_settings.site_name }}{% endblock %}

{% block meta_description %}{{ post.excerpt|default:post.title }}{% endblock %}

{% block body_class %}blog-detail-page{% endblock %}

{% block content %}
<!-- Article Header -->
<article class="blog-article">
    <header class="article-header py-5 mt-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <!-- Breadcrumb -->
                    <nav aria-label="breadcrumb" data-aos="fade-up">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{% url 'portfolio:home' %}">Home</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'portfolio:blog' %}">Blog</a></li>
                            <li class="breadcrumb-item active" aria-current="page">{{ post.title|truncatewords:3 }}</li>
                        </ol>
                    </nav>
                    
                    <!-- Article Meta -->
                    <div class="article-meta mb-3" data-aos="fade-up" data-aos-delay="100">
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            {% if post.category %}
                            <span class="badge rounded-pill fs-6" 
                                  style="background-color: {{ post.category.color }}; color: white;">
                                {{ post.category.name }}
                            </span>
                            {% endif %}
                            
                            {% if post.is_featured %}
                            <span class="badge bg-warning text-dark fs-6">
                                <i class="bi bi-star-fill me-1"></i>Featured
                            </span>
                            {% endif %}
                            
                            <span class="text-muted">
                                <i class="bi bi-calendar me-1"></i>{{ post.created_at|date:"F d, Y" }}
                            </span>
                            
                            <span class="text-muted">
                                <i class="bi bi-clock me-1"></i>{{ post.read_time }} min read
                            </span>
                            
                            {% if post.views_count %}
                            <span class="text-muted">
                                <i class="bi bi-eye me-1"></i>{{ post.views_count }} views
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Article Title -->
                    <h1 class="article-title display-5 fw-bold mb-4" data-aos="fade-up" data-aos-delay="200">
                        {{ post.title }}
                    </h1>
                    
                    <!-- Article Excerpt -->
                    {% if post.excerpt %}
                    <p class="article-excerpt lead text-muted mb-4" data-aos="fade-up" data-aos-delay="300">
                        {{ post.excerpt }}
                    </p>
                    {% endif %}
                    
                    <!-- Author Info -->
                    <div class="author-info d-flex align-items-center mb-4" data-aos="fade-up" data-aos-delay="400">
                        {% if post.author.profile.profile_image_base64 %}
                        <img src="{{ post.author.profile.profile_image_base64 }}" 
                             class="rounded-circle me-3" 
                             alt="{{ post.author.get_full_name|default:post.author.username }}"
                             style="width: 50px; height: 50px; object-fit: cover;">
                        {% else %}
                        <div class="author-avatar bg-primary text-white rounded-circle me-3 d-flex align-items-center justify-content-center"
                             style="width: 50px; height: 50px;">
                            <i class="bi bi-person"></i>
                        </div>
                        {% endif %}
                        
                        <div>
                            <div class="author-name fw-semibold">
                                {{ post.author.get_full_name|default:post.author.username }}
                            </div>
                            <div class="author-title text-muted small">
                                {{ post.author.profile.job_title|default:"Author" }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Featured Image -->
    {% if post.featured_image_url %}
    <section class="article-image">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="featured-image-wrapper" data-aos="fade-up">
                        <img src="{{ post.featured_image_url }}" 
                             class="img-fluid rounded shadow-lg w-100" 
                             alt="{{ post.title }}"
                             style="max-height: 500px; object-fit: cover;">
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}
    
    <!-- Article Content -->
    <section class="article-content py-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <!-- Table of Contents (if content is long) -->
                    <div class="table-of-contents bg-light rounded p-4 mb-5 d-none" id="toc">
                        <h6 class="mb-3">Table of Contents</h6>
                        <ul class="list-unstyled mb-0" id="toc-list">
                            <!-- Generated by JavaScript -->
                        </ul>
                    </div>
                    
                    <!-- Main Content -->
                    <div class="content-text" data-aos="fade-up">
                        {{ post.content|safe }}
                    </div>
                    
                    <!-- Tags -->
                    {% if post.tags.count %}
                    <div class="article-tags mt-5 pt-4 border-top" data-aos="fade-up">
                        <h6 class="mb-3">Tags</h6>
                        <div class="tags-list">
                            {% for tag in post.tags.all %}
                            <a href="{% url 'portfolio:blog' %}?tag={{ tag.slug }}" 
                               class="badge bg-light text-dark me-2 mb-2 text-decoration-none">
                                #{{ tag.name }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Share Article -->
                    <div class="article-share mt-5 pt-4 border-top" data-aos="fade-up">
                        <h6 class="mb-3">Share this article</h6>
                        <div class="share-buttons d-flex gap-2">
                            <a href="https://twitter.com/intent/tweet?text={{ post.title|urlencode }}&url={{ request.build_absolute_uri }}" 
                               target="_blank" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-twitter me-2"></i>Twitter
                            </a>
                            <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" 
                               target="_blank" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-linkedin me-2"></i>LinkedIn
                            </a>
                            <a href="mailto:?subject={{ post.title|urlencode }}&body=Check out this article: {{ request.build_absolute_uri }}" 
                               class="btn btn-outline-primary">
                                <i class="bi bi-envelope me-2"></i>Email
                            </a>
                            <button class="btn btn-outline-secondary" id="copyUrlBtn">
                                <i class="bi bi-link-45deg me-2"></i>Copy Link
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

<!-- Author Bio -->
<section class="author-bio py-5 bg-light">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="author-card card border-0 shadow-sm" data-aos="fade-up">
                    <div class="card-body p-4">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                {% if post.author.profile.profile_image_base64 %}
                                <img src="{{ post.author.profile.profile_image_base64 }}" 
                                     class="rounded-circle" 
                                     alt="{{ post.author.get_full_name|default:post.author.username }}"
                                     style="width: 80px; height: 80px; object-fit: cover;">
                                {% else %}
                                <div class="author-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center"
                                     style="width: 80px; height: 80px; font-size: 2rem;">
                                    <i class="bi bi-person"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col">
                                <h5 class="mb-1">{{ post.author.get_full_name|default:post.author.username }}</h5>
                                <p class="text-muted mb-2">{{ post.author.profile.job_title|default:"Author" }}</p>
                                {% if post.author.profile.bio %}
                                <p class="mb-3">{{ post.author.profile.bio|truncatewords:30 }}</p>
                                {% else %}
                                <p class="mb-3">Passionate developer and writer sharing insights about technology and software development.</p>
                                {% endif %}
                                
                                <!-- Author Social Links -->
                                <div class="author-social d-flex gap-2">
                                    {% if post.author.profile.website %}
                                    <a href="{{ post.author.profile.website }}" 
                                       target="_blank" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-globe"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if post.author.profile.github_url %}
                                    <a href="{{ post.author.profile.github_url }}" 
                                       target="_blank" 
                                       class="btn btn-outline-dark btn-sm">
                                        <i class="bi bi-github"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if post.author.profile.linkedin_url %}
                                    <a href="{{ post.author.profile.linkedin_url }}" 
                                       target="_blank" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-linkedin"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if post.author.profile.twitter_url %}
                                    <a href="{{ post.author.profile.twitter_url }}" 
                                       target="_blank" 
                                       class="btn btn-outline-info btn-sm">
                                        <i class="bi bi-twitter"></i>
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Articles -->
{% if related_posts %}
<section class="related-articles py-5">
    <div class="container">
        <div class="text-center mb-5" data-aos="fade-up">
            <h2 class="h3 mb-3">Related Articles</h2>
            <p class="text-muted">Continue reading with these related posts</p>
        </div>
        
        <div class="row g-4">
            {% for related_post in related_posts %}
            <div class="col-lg-4" data-aos="fade-up" data-aos-delay="{{ forloop.counter0|mul:100 }}">
                <article class="card border-0 shadow-sm h-100 hover-lift">
                    {% if related_post.featured_image_url %}
                    <img src="{{ related_post.featured_image_url }}" 
                         class="card-img-top" 
                         alt="{{ related_post.title }}"
                         style="height: 200px; object-fit: cover;">
                    {% endif %}
                    
                    <div class="card-body">
                        {% if related_post.category %}
                        <span class="badge mb-2" 
                              style="background-color: {{ related_post.category.color }}; color: white;">
                            {{ related_post.category.name }}
                        </span>
                        {% endif %}
                        
                        <h5 class="card-title">
                            <a href="{% url 'portfolio:blog_detail' related_post.slug %}" 
                               class="text-decoration-none text-dark">
                                {{ related_post.title }}
                            </a>
                        </h5>
                        
                        <p class="card-text text-muted">{{ related_post.excerpt|default:related_post.title|truncatewords:15 }}</p>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-calendar me-1"></i>{{ related_post.created_at|date:"M d, Y" }}
                            </small>
                            <a href="{% url 'portfolio:blog_detail' related_post.slug %}" 
                               class="btn btn-outline-primary btn-sm">
                                Read More
                            </a>
                        </div>
                    </div>
                </article>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

<!-- Newsletter Subscription -->
<section class="newsletter-section py-5 bg-primary text-white">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-6 text-center" data-aos="fade-up">
                <h3 class="h4 mb-3">Stay Updated</h3>
                <p class="mb-4">
                    Get the latest articles and insights delivered straight to your inbox. 
                    No spam, unsubscribe anytime.
                </p>
                
                <form class="newsletter-form d-flex gap-2 justify-content-center">
                    <input type="email" 
                           class="form-control" 
                           placeholder="Enter your email" 
                           style="max-width: 300px;"
                           required>
                    <button type="submit" class="btn btn-light">
                        <i class="bi bi-envelope"></i> Subscribe
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Back to Blog -->
<section class="py-4 bg-light">
    <div class="container">
        <div class="text-center">
            <a href="{% url 'portfolio:blog' %}" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>Back to All Articles
            </a>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
/* Article Header Styling */
.article-header {
    background: linear-gradient(135deg, rgba(var(--theme-primary), 0.05), rgba(var(--theme-secondary), 0.05));
}

.article-title {
    line-height: 1.2;
    color: var(--theme-text);
}

.article-excerpt {
    font-size: 1.25rem;
    line-height: 1.6;
}

/* Author Info */
.author-info {
    padding: 1rem 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

/* Content Styling */
.content-text {
    line-height: 1.8;
    font-size: 1.1rem;
}

.content-text h1,
.content-text h2,
.content-text h3,
.content-text h4,
.content-text h5,
.content-text h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: var(--theme-text);
}

.content-text p {
    margin-bottom: 1.5rem;
}

.content-text blockquote {
    background: var(--theme-background);
    border-left: 4px solid var(--theme-primary);
    padding: 1rem 1.5rem;
    margin: 2rem 0;
    font-style: italic;
}

.content-text code {
    background: var(--theme-background);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
    color: #e83e8c;
}

.content-text pre {
    background: var(--theme-background);
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 1.5rem 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.content-text pre code {
    background: none;
    padding: 0;
    color: inherit;
}

/* CKEditor rich text content styling */
.content-text ul, 
.content-text ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
}

.content-text ul li,
.content-text ol li {
    margin-bottom: 0.5rem;
}

.content-text table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.content-text table th,
.content-text table td {
    padding: 0.75rem;
    border: 1px solid rgba(0, 0, 0, 0.1);
    text-align: left;
}

.content-text table th {
    background: var(--theme-background);
    font-weight: 600;
}

.content-text img {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.content-text a {
    color: var(--theme-primary);
    text-decoration: underline;
    transition: color 0.2s ease;
}

.content-text a:hover {
    color: var(--theme-secondary);
}

.content-text strong {
    font-weight: 600;
    color: var(--theme-text);
}

.content-text em {
    font-style: italic;
}

.content-text mark {
    background: rgba(var(--theme-primary), 0.2);
    padding: 0.1rem 0.2rem;
    border-radius: 3px;
}

/* Code block syntax highlighting */
.content-text .ck-code-block {
    position: relative;
    background: #2d3748;
    color: #e2e8f0;
    border-radius: 8px;
    margin: 1.5rem 0;
    overflow: hidden;
}

.content-text .ck-code-block code {
    background: none;
    color: inherit;
    padding: 1rem;
    display: block;
    white-space: pre-wrap;
}

/* Table of Contents */
.table-of-contents {
    position: sticky;
    top: 100px;
    max-height: 300px;
    overflow-y: auto;
}

.table-of-contents a {
    color: var(--theme-text);
    text-decoration: none;
    padding: 0.25rem 0;
    display: block;
    border-left: 2px solid transparent;
    padding-left: 0.5rem;
    transition: all 0.2s ease;
}

.table-of-contents a:hover,
.table-of-contents a.active {
    color: var(--theme-primary);
    border-left-color: var(--theme-primary);
    background: rgba(var(--theme-primary), 0.1);
}

/* Tags */
.tags-list .badge {
    font-size: 0.875rem;
    padding: 0.5rem 0.75rem;
    transition: all 0.2s ease;
}

.tags-list .badge:hover {
    background: var(--theme-primary) !important;
    color: white !important;
    transform: translateY(-1px);
}

/* Share Buttons */
.share-buttons .btn {
    flex: 1;
    max-width: 150px;
}

/* Author Card */
.author-card {
    transition: transform 0.3s ease;
}

.author-card:hover {
    transform: translateY(-2px);
}

/* Related Articles */
.related-articles .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.related-articles .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1) !important;
}

/* Newsletter Form */
.newsletter-form input:focus {
    border-color: rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
}

/* Breadcrumb */
.breadcrumb {
    background: none;
    padding: 0;
    margin: 0;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: '>';
    color: var(--theme-primary);
}

.breadcrumb-item a {
    color: var(--theme-primary);
    text-decoration: none;
}

.breadcrumb-item a:hover {
    text-decoration: underline;
}

/* Responsive Design */
@media (max-width: 768px) {
    .article-title {
        font-size: 2rem !important;
    }
    
    .article-excerpt {
        font-size: 1.1rem;
    }
    
    .content-text {
        font-size: 1rem;
    }
    
    .share-buttons {
        flex-direction: column;
    }
    
    .share-buttons .btn {
        max-width: none;
    }
    
    .table-of-contents {
        position: static;
        margin-bottom: 2rem;
    }
}

/* Dark Mode Adjustments */
[data-bs-theme="dark"] .author-info {
    border-color: rgba(255, 255, 255, 0.1);
}

[data-bs-theme="dark"] .content-text blockquote {
    background: rgba(255, 255, 255, 0.05);
}

[data-bs-theme="dark"] .content-text code,
[data-bs-theme="dark"] .content-text pre {
    background: rgba(255, 255, 255, 0.05);
}

[data-bs-theme="dark"] .content-text table th {
    background: rgba(255, 255, 255, 0.05);
}

[data-bs-theme="dark"] .content-text table th,
[data-bs-theme="dark"] .content-text table td {
    border-color: rgba(255, 255, 255, 0.1);
}

[data-bs-theme="dark"] .content-text table {
    border-color: rgba(255, 255, 255, 0.1);
}

[data-bs-theme="dark"] .content-text mark {
    background: rgba(var(--theme-primary), 0.3);
    color: rgba(255, 255, 255, 0.9);
}

[data-bs-theme="dark"] .table-of-contents {
    background: rgba(255, 255, 255, 0.05) !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Generate Table of Contents
    generateTableOfContents();
    
    // Copy URL functionality
    const copyUrlBtn = document.getElementById('copyUrlBtn');
    if (copyUrlBtn) {
        copyUrlBtn.addEventListener('click', function() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const originalText = this.innerHTML;
                this.innerHTML = '<i class="bi bi-check me-2"></i>Copied!';
                setTimeout(() => {
                    this.innerHTML = originalText;
                }, 2000);
            });
        });
    }
    
    // Newsletter form submission
    const newsletterForm = document.querySelector('.newsletter-form');
    if (newsletterForm) {
        newsletterForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = this.querySelector('input[type="email"]').value;
            const button = this.querySelector('button');
            
            if (email) {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i> Subscribed!';
                button.disabled = true;
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    this.reset();
                }, 2000);
            }
        });
    }
    
    // Smooth scrolling for TOC links
    document.addEventListener('click', function(e) {
        if (e.target.matches('.toc-link')) {
            e.preventDefault();
            const targetId = e.target.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
                
                // Update active TOC link
                document.querySelectorAll('.toc-link').forEach(link => {
                    link.classList.remove('active');
                });
                e.target.classList.add('active');
            }
        }
    });
    
    // Reading progress indicator
    createReadingProgress();
    
    // Track article view
    console.log('Article viewed: {{ post.slug }}');
});

function generateTableOfContents() {
    const contentText = document.querySelector('.content-text');
    const tocList = document.getElementById('toc-list');
    const tocContainer = document.getElementById('toc');
    
    if (!contentText || !tocList) return;
    
    const headings = contentText.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    if (headings.length < 3) return; // Only show TOC if there are enough headings
    
    tocContainer.classList.remove('d-none');
    
    headings.forEach((heading, index) => {
        // Create unique ID if it doesn't exist
        if (!heading.id) {
            heading.id = `heading-${index}`;
        }
        
        // Create TOC entry
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${heading.id}`;
        a.textContent = heading.textContent;
        a.className = 'toc-link';
        
        // Add indentation based on heading level
        const level = parseInt(heading.tagName.substring(1));
        li.style.paddingLeft = `${(level - 1) * 1}rem`;
        
        li.appendChild(a);
        tocList.appendChild(li);
    });
}

function createReadingProgress() {
    // Create progress bar
    const progressBar = document.createElement('div');
    progressBar.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: var(--theme-primary);
        z-index: 9999;
        transition: width 0.1s ease;
    `;
    document.body.appendChild(progressBar);
    
    // Update progress on scroll
    window.addEventListener('scroll', function() {
        const article = document.querySelector('.article-content');
        if (!article) return;
        
        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset;
        
        const start = articleTop - windowHeight;
        const end = articleTop + articleHeight;
        const progress = Math.min(Math.max((scrollTop - start) / (end - start), 0), 1);
        
        progressBar.style.width = `${progress * 100}%`;
    });
}
</script>
{% endblock %}