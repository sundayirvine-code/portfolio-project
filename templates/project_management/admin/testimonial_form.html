{% extends 'parameters/admin/base_admin.html' %}
{% load static %}

{% block breadcrumb %}
<li class="breadcrumb-item">
    <a href="{% url 'portfolio:testimonial_list' %}" class="text-decoration-none">Testimonials</a>
</li>
<li class="breadcrumb-item active" aria-current="page">
    {% if testimonial %}Edit Testimonial{% else %}Create Testimonial{% endif %}
</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <button type="submit" form="testimonialForm" class="btn btn-primary">
        <i class="bi bi-check-lg me-1"></i>{{ form_action }} Testimonial
    </button>
    <a href="{% url 'portfolio:testimonial_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Testimonials
    </a>
</div>
{% endblock %}

{% block admin_content %}
<div class="row">
    <div class="col-lg-8">
        <form method="post" id="testimonialForm" class="needs-validation" novalidate>
            {% csrf_token %}
            
            <!-- Client Information -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person me-2"></i>Client Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.client_name.id_for_label }}" class="form-label">
                                    Client Name <span class="text-danger">*</span>
                                </label>
                                {{ form.client_name }}
                                {% if form.client_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.client_name.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Full name of the client</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.client_email.id_for_label }}" class="form-label">Client Email</label>
                                {{ form.client_email }}
                                {% if form.client_email.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.client_email.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Client's email address (optional)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.client_position.id_for_label }}" class="form-label">Position/Title</label>
                                {{ form.client_position }}
                                {% if form.client_position.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.client_position.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Client's job title or position</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.client_company.id_for_label }}" class="form-label">Company</label>
                                {{ form.client_company }}
                                {% if form.client_company.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.client_company.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Client's company or organization</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Photo Upload -->
                    <div class="mb-3">
                        <label for="clientPhotoUpload" class="form-label">Client Photo</label>
                        <div class="row">
                            <div class="col-md-8">
                                <input type="file" 
                                       class="form-control" 
                                       id="clientPhotoUpload" 
                                       accept="image/*"
                                       onchange="handleClientPhotoUpload(this)">
                                <div class="form-text">Upload client photo (will be resized to 200x200px, max 5MB)</div>
                            </div>
                            <div class="col-md-4">
                                <div id="clientPhotoPreview" class="image-preview">
                                    {% if testimonial and testimonial.client_photo_url %}
                                    <img src="{{ testimonial.client_photo_url }}" alt="Client Photo" class="img-thumbnail w-100 rounded-circle client-photo-preview">
                                    {% else %}
                                    <div class="placeholder-image d-flex align-items-center justify-content-center bg-light rounded-circle client-photo-placeholder">
                                        <i class="bi bi-person text-muted fs-3"></i>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <!-- Hidden field to store base64 data -->
                        {{ form.client_photo_file }}
                        {% if form.client_photo_file.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.client_photo_file.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Testimonial Content -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-quote me-2"></i>Testimonial Content
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="{{ form.content.id_for_label }}" class="form-label">
                            Testimonial Content <span class="text-danger">*</span>
                        </label>
                        {{ form.content }}
                        {% if form.content.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.content.errors %}{{ error }}{% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">The testimonial text from the client</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.rating.id_for_label }}" class="form-label">
                                    Rating <span class="text-danger">*</span>
                                </label>
                                {{ form.rating }}
                                {% if form.rating.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.rating.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Rating from 1 to 5 stars</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.project.id_for_label }}" class="form-label">Related Project</label>
                                {{ form.project }}
                                {% if form.project.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.project.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Project this testimonial is about (optional)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.date_given.id_for_label }}" class="form-label">Date Given</label>
                                {{ form.date_given }}
                                {% if form.date_given.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.date_given.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">When the testimonial was provided</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.display_order.id_for_label }}" class="form-label">Display Order</label>
                                {{ form.display_order }}
                                {% if form.display_order.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.display_order.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Order in which testimonial appears (lower = first)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                {{ form.is_approved }}
                                <label class="form-check-label" for="{{ form.is_approved.id_for_label }}">
                                    Approved for Display
                                </label>
                                {% if form.is_approved.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_approved.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Whether this testimonial is approved for public display</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check mt-4">
                                {{ form.is_featured }}
                                <label class="form-check-label" for="{{ form.is_featured.id_for_label }}">
                                    Featured Testimonial
                                </label>
                                {% if form.is_featured.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.is_featured.errors %}{{ error }}{% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">Highlight this testimonial on the homepage</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="col-lg-4">
        <!-- Live Preview -->
        <div class="card sticky-top" style="top: 1rem;">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-eye me-2"></i>Live Preview
                </h6>
            </div>
            <div class="card-body">
                <div id="testimonialPreview">
                    <!-- Testimonial preview will be populated by JavaScript -->
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-chat-quote display-4 mb-2"></i>
                        <p>Fill out the form to see a preview</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Tips -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightbulb me-2"></i>Quick Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small mb-0">
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-1"></i>
                        Always get permission before publishing
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-1"></i>
                        Keep testimonials authentic and unedited
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-1"></i>
                        Featured testimonials appear on homepage
                    </li>
                    <li class="mb-2">
                        <i class="bi bi-check text-success me-1"></i>
                        Include client position for credibility
                    </li>
                    <li class="mb-0">
                        <i class="bi bi-check text-success me-1"></i>
                        Lower order numbers display first
                    </li>
                </ul>
            </div>
        </div>
        
        {% if testimonial %}
        <!-- Testimonial Statistics -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up me-2"></i>Testimonial Details
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="d-flex justify-content-between mb-2">
                        <span>Characters:</span>
                        <span class="badge bg-info">{{ testimonial.content|length }}</span>
                    </li>
                    {% if testimonial.date_given %}
                    <li class="d-flex justify-content-between mb-2">
                        <span>Date Given:</span>
                        <span class="small text-muted">{{ testimonial.date_given|date:"M d, Y" }}</span>
                    </li>
                    {% endif %}
                    <li class="d-flex justify-content-between mb-2">
                        <span>Created:</span>
                        <span class="small text-muted">{{ testimonial.created_at|date:"M d, Y" }}</span>
                    </li>
                    <li class="d-flex justify-content-between">
                        <span>Updated:</span>
                        <span class="small text-muted">{{ testimonial.updated_at|date:"M d, Y" }}</span>
                    </li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<style>
.form-control:focus,
.form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.testimonial-preview-card {
    border: 1px solid rgba(0,0,0,0.125);
    border-radius: 0.375rem;
    padding: 1.5rem;
    background: #fff;
}

.client-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    font-size: 1.5rem;
}

.stars {
    color: #ffc107;
}

.testimonial-quote {
    position: relative;
    font-style: italic;
    margin: 1rem 0;
}

.testimonial-quote::before {
    content: '"';
    font-size: 4rem;
    position: absolute;
    left: -15px;
    top: -20px;
    color: rgba(0,0,0,0.1);
    font-family: serif;
}

/* Image upload styling */
.image-preview {
    min-height: 120px;
    border: 2px dashed #dee2e6;
    border-radius: 50%;
    overflow: hidden;
    width: 120px;
    height: 120px;
    margin: 0 auto;
}

.client-photo-preview {
    width: 120px;
    height: 120px;
    object-fit: cover;
}

.client-photo-placeholder {
    width: 120px;
    height: 120px;
    border: 2px dashed #dee2e6;
    cursor: pointer;
    transition: border-color 0.3s ease;
    margin: 0 auto;
}

.client-photo-placeholder:hover {
    border-color: #0d6efd;
}

/* Dark mode support */
[data-bs-theme="dark"] .testimonial-preview-card {
    background: var(--bs-dark);
    border-color: rgba(255,255,255,0.125);
}

[data-bs-theme="dark"] .client-avatar {
    background: rgba(255,255,255,0.1);
}

[data-bs-theme="dark"] .testimonial-quote::before {
    color: rgba(255,255,255,0.1);
}

[data-bs-theme="dark"] .client-photo-placeholder {
    border-color: rgba(255, 255, 255, 0.3);
    background-color: rgba(255, 255, 255, 0.05);
}

[data-bs-theme="dark"] .client-photo-placeholder:hover {
    border-color: #0d6efd;
}
</style>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Live preview updates
    const formFields = document.querySelectorAll('#testimonialForm input, #testimonialForm textarea, #testimonialForm select');
    formFields.forEach(field => {
        field.addEventListener('input', updatePreview);
        field.addEventListener('change', updatePreview);
    });
    
    // Initial preview update
    updatePreview();
    
    function updatePreview() {
        const clientName = document.getElementById('{{ form.client_name.id_for_label }}')?.value || '';
        const clientPosition = document.getElementById('{{ form.client_position.id_for_label }}')?.value || '';
        const clientCompany = document.getElementById('{{ form.client_company.id_for_label }}')?.value || '';
        const content = document.getElementById('{{ form.content.id_for_label }}')?.value || '';
        const rating = parseInt(document.getElementById('{{ form.rating.id_for_label }}')?.value) || 0;
        const isApproved = document.getElementById('{{ form.is_approved.id_for_label }}')?.checked || false;
        const isFeatured = document.getElementById('{{ form.is_featured.id_for_label }}')?.checked || false;
        
        const preview = document.getElementById('testimonialPreview');
        
        if (!clientName && !content) {
            preview.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="bi bi-chat-quote display-4 mb-2"></i>
                    <p>Fill out the form to see a preview</p>
                </div>
            `;
            return;
        }
        
        // Generate stars
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                starsHtml += '<i class="bi bi-star-fill text-warning"></i>';
            } else {
                starsHtml += '<i class="bi bi-star text-muted"></i>';
            }
        }
        
        let badgesHtml = '';
        if (isApproved) {
            badgesHtml += '<span class="badge bg-success me-1">Approved</span>';
        } else {
            badgesHtml += '<span class="badge bg-warning me-1">Pending</span>';
        }
        if (isFeatured) {
            badgesHtml += '<span class="badge bg-primary">Featured</span>';
        }
        
        let clientInfo = '';
        if (clientPosition || clientCompany) {
            clientInfo = `<div class="small text-muted">${clientPosition}${clientPosition && clientCompany ? ' at ' : ''}${clientCompany}</div>`;
        }
        
        // Get client photo preview
        const photoPreview = document.querySelector('#clientPhotoPreview img');
        const photoSrc = photoPreview ? photoPreview.src : '';
        const avatarHtml = photoSrc ? 
            `<img src="${photoSrc}" alt="Client Photo" class="client-avatar">` :
            `<div class="client-avatar"><i class="bi bi-person"></i></div>`;
        
        preview.innerHTML = `
            <div class="testimonial-preview-card">
                <div class="d-flex align-items-start mb-3">
                    ${avatarHtml}
                    <div class="flex-grow-1 ms-3">
                        <h6 class="mb-0">${clientName || 'Client Name'}</h6>
                        ${clientInfo}
                        <div class="mt-1">${starsHtml}</div>
                    </div>
                </div>
                
                <div class="testimonial-quote">
                    "${content || 'Testimonial content will appear here...'}"
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <div>${badgesHtml}</div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary" disabled>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" disabled>
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Character counter for content
    const contentField = document.getElementById('{{ form.content.id_for_label }}');
    if (contentField) {
        const counter = document.createElement('div');
        counter.className = 'form-text mt-1';
        counter.innerHTML = '<span id="charCount">0</span> characters';
        contentField.parentNode.appendChild(counter);
        
        contentField.addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
        });
        
        // Initial count
        document.getElementById('charCount').textContent = contentField.value.length;
    }
    
    // Form validation
    const form = document.getElementById('testimonialForm');
    form.addEventListener('submit', function(e) {
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});

// Handle client photo upload
function handleClientPhotoUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        input.value = '';
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please select a valid image file');
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Resize image to 200x200 square
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 200;
            canvas.height = 200;
            
            // Draw and compress - crop to square
            const size = Math.min(img.width, img.height);
            const x = (img.width - size) / 2;
            const y = (img.height - size) / 2;
            
            ctx.drawImage(img, x, y, size, size, 0, 0, 200, 200);
            const base64Data = canvas.toDataURL('image/jpeg', 0.85);
            
            // Update preview
            const preview = document.getElementById('clientPhotoPreview');
            preview.innerHTML = `<img src="${base64Data}" alt="Client Photo" class="img-thumbnail w-100 rounded-circle client-photo-preview">`;
            
            // Update hidden field
            const hiddenField = document.getElementById('{{ form.client_photo_file.id_for_label }}');
            if (hiddenField) {
                hiddenField.value = base64Data;
            }
            
            // Update live preview
            updatePreview();
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}
</script>
{% endblock %}